<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>TaskPulse Advisor</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0d12">
<link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192.png">
<style>
:root{--bg:#0b0d12;--ink:#ecf2ff;--mut:#aab3c5;--pri:#7c5cff;--good:#29d78a;--bad:#ff6b6b;--card:#141a2a;--line:#24304e}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:12px 12px 140px} /* extra bottom padding for mobile tabs */
header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0 10px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:10px}
.logo-mark{width:40px;height:40px;border-radius:12px;overflow:hidden;border:1px solid #263155;display:grid;place-items:center;background:#0e1426;color:#7c9fff;font-weight:800}
h1{margin:0;font-size:22px;font-weight:800}
.mut{color:var(--mut)}
.btn{padding:12px 14px;border-radius:12px;border:1px solid #2b3555;background:#1b2340;color:#fff;cursor:pointer}
.btn.pri{background:#5e41ff}
.btn.good{background:#1dbb79}
.btn.bad{background:#b93e3e}
.btn.block{display:block;width:100%}
.btn[disabled]{opacity:.5;pointer-events:none}
.input,select{width:100%;padding:12px;border-radius:12px;background:#0f1526;border:1px solid #27325a;color:#e8eeff}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:0 0 12px}
.stack{display:flex;flex-direction:column;gap:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.pill{padding:6px 8px;border-radius:999px;border:1px solid #313d6e;background:#11172a;color:#cbd6ff;font-size:12px}
.list .rowi{display:grid;grid-template-columns:100px 1.4fr 1fr 90px 110px 110px;gap:8px;align-items:center;padding:10px 0;border-bottom:1px dashed #273155}
.amt{font-weight:700}
.tabs{position:sticky;top:0;z-index:5;display:flex;gap:8px;overflow:auto;padding:8px 2px 12px;background:linear-gradient(180deg,#0b0d12 70%,rgba(11,13,18,0))}
.tab{padding:12px 16px;border-radius:12px;border:1px solid #2b3555;background:#131a2a;color:#d9e1ff;cursor:pointer;flex:0 0 auto}
.tab[aria-selected="true"]{background:linear-gradient(180deg,#1c2540,#151c2e);border-color:#3a4581;color:#fff}
@media(max-width:820px){
  header .stack{width:100%;gap:8px}
  header .stack .btn{flex:1}
  .grid2{grid-template-columns:1fr}
  .tabs{position:fixed;bottom:0;top:auto;background:#0c0f19;border-top:1px solid #20263a;justify-content:space-between;padding:8px 10px}
  .tab{flex:1;text-align:center}
  .list .rowi{grid-template-columns:70px 1fr 1fr 80px 90px}
  .btn.block-sm{display:block;width:100%}
}
.hidden{display:none}
pre{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>
<!-- pdf.js and worker: needed for mobile Chromium -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">
      <div class="logo-mark" aria-hidden="true">TP</div>
      <div>
        <h1>TaskPulse <span style="opacity:.9">Advisor</span></h1>
        <div class="mut" style="font-size:12px">Financial advisor • planner • tracker (PDF-first, offline-first)</div>
      </div>
    </div>
    <div class="stack" style="flex-direction:row;flex-wrap:wrap;gap:8px">
      <button class="btn" id="btnExport">Export</button>
      <label class="btn" for="jsonIn">Import JSON</label>
      <input id="jsonIn" type="file" accept="application/json" class="hidden">
      <label class="btn pri" for="pdfIn">Import PDF</label>
      <input id="pdfIn" type="file" accept="application/pdf" class="hidden">
    </div>
  </header>

  <nav class="tabs" role="tablist">
    <button class="tab" data-tab="home" aria-selected="true">Home</button>
    <button class="tab" data-tab="statements">Statements</button>
    <button class="tab" data-tab="budgets">Budgets</button>
    <button class="tab" data-tab="goals">Goals</button>
    <button class="tab" data-tab="reports">Reports</button>
    <button class="tab" data-tab="settings">Settings</button>
  </nav>

  <section id="tab-home">
    <div class="card"><div class="mut">Go to Statements → import your PDF. After parsing, press “Add to ledger”.</div></div>
  </section>

  <section id="tab-statements" class="hidden">
    <div class="grid2">
      <div class="card">
        <h3>Import bank statement (PDF)</h3>
        <div class="stack">
          <div class="mut" style="font-size:12px">On-device parsing. Nothing leaves your phone/laptop.</div>

          <!-- Reliable mobile tap target -->
          <label class="btn pri block-sm" for="pdfChoose">Choose PDF</label>
          <input id="pdfChoose" type="file" accept="application/pdf" class="hidden">

          <div id="importSummary" class="mut" style="font-size:12px">No transactions found.</div>

          <!-- Debug toggle + dump -->
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="debugToggle">
            <span class="mut" style="font-size:12px">Debug: show extracted text</span>
          </label>
          <pre id="debugDump" class="hidden" style="max-height:220px;overflow:auto;background:#0f1424;border:1px solid #253155;border-radius:10px;padding:10px;white-space:pre-wrap"></pre>

          <div id="commitBar" class="stack hidden" style="gap:8px">
            <button class="btn good block-sm" id="commitImport" disabled>Add to ledger</button>
            <button class="btn bad block-sm" id="discardImport" disabled>Discard</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Merchant rename rules</h3>
        <div id="renameList" class="stack"></div>
        <form id="renameForm" class="grid2">
          <input class="input" id="rnMatch" placeholder="Match (e.g., shoprite holdings)" required>
          <input class="input" id="rnTo" placeholder="Rename to (e.g., Shoprite)" required>
          <select class="input" id="rnMode">
            <option value="contains">contains</option>
            <option value="exact">exact</option>
            <option value="regex">regex</option>
          </select>
          <button class="btn">Add rename</button>
        </form>
        <div class="mut" style="font-size:12px">Renames run before categorisation.</div>
      </div>
    </div>

    <div class="card">
      <h3>Review & approve (first 30 rows)</h3>
      <div id="reviewList" class="list"></div>
    </div>
  </section>

  <section id="tab-budgets" class="hidden"><div class="card"><h3>Budgets</h3></div></section>
  <section id="tab-goals" class="hidden"><div class="card"><h3>Goals</h3></div></section>
  <section id="tab-reports" class="hidden"><div class="card"><h3>Reports</h3></div></section>
  <section id="tab-settings" class="hidden"><div class="card"><h3>Settings</h3><div class="mut" style="font-size:12px">Overdraft guard: R500.</div></div></section>

  <footer class="mut" style="text-align:center;margin:20px 0 8px;font-size:12px">Powered by Daryl G</footer>
</div>

<template id="txRowTpl">
  <div class="rowi">
    <div class="mut dt"></div>
    <div class="desc"></div>
    <div class="pill cat"></div>
    <div class="pill type"></div>
    <div class="amt"></div>
    <div style="display:flex;gap:8px"><button class="btn">Edit</button><button class="btn bad">Delete</button></div>
  </div>
</template>

<script>
/* short helpers */
const $=(s,p=document)=>p.querySelector(s), $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
const fmt=new Intl.NumberFormat('en-ZA',{style:'currency',currency:'ZAR'});
const state={tx:[],renames:[],pending:[]};
function save(){localStorage.setItem('tp-advisor',JSON.stringify(state));}
function load(){try{Object.assign(state,JSON.parse(localStorage.getItem('tp-advisor')||'{}')||{});}catch{}}
load();

/* tabs */
$$('.tab').forEach(b=>b.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.setAttribute('aria-selected','false')); b.setAttribute('aria-selected','true');
  ['home','statements','budgets','goals','reports','settings'].forEach(id=>$('#tab-'+id).classList.add('hidden'));
  $('#tab-'+b.dataset.tab).classList.remove('hidden');
}));

/* export/import JSON */
$('#btnExport').addEventListener('click',()=>{
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
  a.download='taskpulse-advisor.json'; a.click();
});
document.addEventListener('change', async e=>{
  if(e.target && e.target.id==='jsonIn'){
    const f=(e.target.files && e.target.files[0])||null; if(!f) return;
    const t=await f.text(); try{Object.assign(state,JSON.parse(t)); save(); alert('Imported JSON.');}catch{alert('Bad JSON');}
  }
});

/* rename rules */
function normaliseMerchant(s){return (s||'').toLowerCase().replace(/\s+/g,' ').replace(/\d+/g,'').replace(/[^a-z\s:&]/g,'').trim();}
function applyRenameRaw(d){
  let o=d||'';
  for(const r of (state.renames||[])){
    try{
      if(r.mode==='exact' && o.toLowerCase().trim()===(r.match||'').toLowerCase().trim()) o=r.to;
      else if(r.mode==='contains' && o.toLowerCase().includes(String(r.match||'').toLowerCase())) o=r.to;
      else if(r.mode==='regex'){ const re=new RegExp(String(r.match||''),'i'); if(re.test(o)) o=o.replace(re,r.to); }
    }catch{}
  }
  return o;
}
function autoCategory(t){
  const s=(t.merchant||'')+' '+(t.raw||'');
  const rules=[
    {re:/bp|garage|fuel|motors/i,cat:'Transport:Fuel'},
    {re:/youtube|spotify|netflix|openai|google/i,cat:'Subscriptions'},
    {re:/service fee|monthly fee|vat|int on debit/i,cat:'Fees'}
  ];
  for(const r of rules) if(r.re.test(s)) return r.cat;
  return 'Uncategorised';
}
function renderRenames(){
  const host=$('#renameList'); host.innerHTML='';
  (state.renames||[]).forEach((r,i)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px';
    row.innerHTML=`<span class="pill">${r.mode}: "${r.match}" → <b>${r.to}</b></span>
                   <button class="btn" data-del="${i}">Delete</button>`;
    row.querySelector('[data-del]').onclick=()=>{state.renames.splice(i,1); save(); renderRenames();};
    host.appendChild(row);
  });
}
renderRenames();
document.addEventListener('submit',e=>{
  if(e.target && e.target.id==='renameForm'){ e.preventDefault();
    const match=$('#rnMatch').value.trim(), to=$('#rnTo').value.trim(), mode=$('#rnMode').value;
    if(!match||!to) return; (state.renames=state.renames||[]).push({match,to,mode});
    e.target.reset(); save(); renderRenames();
  }
});

/* PDF import: bind to BOTH inputs (header and statements) */
let _previewRows=[];
async function handlePdfFile(file){
  if(!file) return;
  const buf = await file.arrayBuffer();
  try{
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let all = '';
    for(let i=1;i<=pdf.numPages;i++){
      const p = await pdf.getPage(i);
      const c = await p.getTextContent();
      all += '\n' + c.items.map(it => it.str).join('\n');
    }

    // Debug: show extracted text
    const showDbg = $('#debugToggle') && $('#debugToggle').checked;
    if (showDbg){
      $('#debugDump').classList.remove('hidden');
      $('#debugDump').textContent = all.slice(0, 20000) || '(No text extracted. This PDF may be a scanned image.)';
    } else {
      $('#debugDump').classList.add('hidden');
      $('#debugDump').textContent = '';
    }

    const parsed = parseBankPdf(all);
    _previewRows = parsed;

    const host = $('#reviewList'); host.innerHTML = '';
    parsed.slice(0,30).forEach(t => host.appendChild(txRow(t)));

    const ok = parsed.length > 0;
    $('#importSummary').textContent = ok
      ? `Ready: ${parsed.length} rows.`
      : (all.trim().length ? 'No transactions matched this layout.' : 'No text in PDF (likely a scanned image).');
    $('#commitBar').classList.toggle('hidden', !ok);
    $('#commitImport').disabled = !ok; $('#discardImport').disabled = !ok;

  }catch(err){
    console.error(err);
    alert('PDF parsing failed (see console).');
  }
}
document.addEventListener('change', async e=>{
  if(e.target && (e.target.id==='pdfChoose' || e.target.id==='pdfIn')){
    const f=(e.target.files && e.target.files[0])||null;
    await handlePdfFile(f);
  }
});
$('#commitImport').addEventListener('click',()=>{
  if(!_previewRows.length) return;
  state.tx=state.tx.concat(_previewRows);
  _previewRows=[]; $('#reviewList').innerHTML='';
  $('#commitBar').classList.add('hidden'); $('#commitImport').disabled=true; $('#discardImport').disabled=true;
  $('#importSummary').textContent='Imported.'; save();
});
$('#discardImport').addEventListener('click',()=>{
  _previewRows=[]; $('#reviewList').innerHTML='';
  $('#commitBar').classList.add('hidden'); $('#commitImport').disabled=true; $('#discardImport').disabled=true;
  $('#importSummary').textContent='Discarded.';
});

/* Row render */
function txRow(t){
  const tpl=document.querySelector('#txRowTpl').content.cloneNode(true), r=tpl.querySelector('.rowi');
  r.querySelector('.dt').textContent=t.date;
  r.querySelector('.desc').textContent=t.desc||'(no description)';
  r.querySelector('.cat').textContent=t.category||'—';
  r.querySelector('.type').textContent=t.type;
  const a=r.querySelector('.amt');
  a.textContent=(t.type==='expense'?'-':'+')+fmt.format(Math.abs(+t.amount));
  a.style.color=t.type==='expense'?'var(--bad)':'var(--good)';
  return r;
}

/* ==== More tolerant FNB parser ==== */
function parseBankPdf(text){
  const lines = text.split(/\n+/).map(s => s.replace(/\u00A0/g,' ').trim()).filter(Boolean);
  if (lines.length === 0) return []; // scanned image → no text

  const mon = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const isDate = tok => /^(?:\d{1,2}\s+[A-Za-z]{3}\s+\d{4}|\d{1,2}\/\d{1,2}\/\d{4}|\d{4}-\d{2}-\d{2})$/.test((tok||'').trim());
  const toISO = tok => {
    tok = (tok||'').trim(); let m;
    if (m = tok.match(/^(\d{1,2})\s+([A-Za-z]{3})\s+(\d{4})$/)) {
      const d=m[1].padStart(2,'0'); const mo=String(mon[m[2].toLowerCase()]||1).padStart(2,'0');
      return `${m[3]}-${mo}-${d}`;
    }
    if (m = tok.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/)) {
      const d=m[1].padStart(2,'0'); const mo=m[2].padStart(2,'0'); return `${m[3]}-${mo}-${d}`;
    }
    if (m = tok.match(/^(\d{4})-(\d{2})-(\d{2})$/)) return `${m[1]}-${m[2]}-${m[3]}`;
    return null;
  };

  // amounts like: R 1 234.56 | 1,234.56 | (450.00) | 450.00 CR | 0.00
  const amtToken = /^(?:R\s*)?(\(?-?\d{1,3}(?:[ ,]\d{3})*|\d+)(?:[.,]\d{2})\)?(?:\s*(?:CR|DR))?$/i;
  const rawNum = s => {
    if(!s) return NaN;
    const neg = /^\(.*\)$/.test(s);
    const cr  = /\bCR\b/i.test(s);
    const dr  = /\bDR\b/i.test(s);
    const n   = parseFloat(String(s).replace(/[R\s,]/g,'').replace(/(CR|DR)/i,''));
    if (isNaN(n)) return NaN;
    if (neg || /-/.test(s) || dr) return -Math.abs(n);
    if (cr) return Math.abs(n);
    return Math.sign(n)===-1 ? -Math.abs(n) : Math.abs(n);
  };

  // stitch wrapped rows on date
  const stitched=[];
  for (const line of lines){
    const parts=line.replace(/\s{2,}/g,'  ').split('  ').map(x=>x.trim()).filter(Boolean);
    if (parts.length && isDate(parts[0])) stitched.push(parts.join('  '));
    else if (stitched.length) stitched[stitched.length-1] += ' ' + line;
  }
  if (stitched.length === 0) stitched.push(...lines);

  const out=[];
  for (const row of stitched){
    const parts=row.split(/\s{2,}/).map(x=>x.trim()).filter(Boolean);
    if (!parts.length) continue;

    let dateIdx=-1, iso=null;
    for (let i=0;i<Math.min(3,parts.length);i++){
      if (isDate(parts[i])) { dateIdx=i; iso=toISO(parts[i]); break; }
    }
    if (!iso) continue;

    const idx=[]; parts.forEach((p,i)=>{ if (amtToken.test(p)) idx.push(i); });
    if (idx.length===0) continue;

    let desc='',type='expense',amount=NaN;
    if (idx.length>=2){
      const prev=parts[idx[idx.length-2]], last=parts[idx[idx.length-1]];
      const vPrev=rawNum(prev), vLast=rawNum(last);
      if (!isNaN(vPrev) && Math.abs(vPrev)>0 && (isNaN(vLast)||Math.abs(vLast)===0)){
        amount=Math.abs(vPrev); type=vPrev<0?'expense':'income';
      } else {
        amount=Math.abs(vLast); type=vLast<0?'expense':'income';
      }
      desc=parts.slice(dateIdx+1, idx[idx.length-2]).join(' ');
    } else {
      const k=idx[0], v=rawNum(parts[k]);
      amount=Math.abs(v); type=v<0?'expense':'income';
      desc=parts.slice(dateIdx+1, k).join(' ');
    }

    if (/\bCR\b/i.test(row)) type='income';

    const rawDesc=(desc||'').trim()||'(no description)';
    const renamed=applyRenameRaw(rawDesc);
    const merch=normaliseMerchant(renamed);

    if (!isNaN(amount) && amount>0){
      out.push({date:iso,type,desc:renamed,merchant:renamed,normMerchant:merch,
                category:autoCategory({merchant:merch,raw:row}),amount,account:'Bank',src:'pdf'});
    }
  }
  return out;
}
</script>
</body>
</html>
